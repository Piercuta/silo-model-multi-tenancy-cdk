# =======================================
# GitLab CI/CD - Dynamic CDK Deployment Pipeline
# =======================================
#
# This pipeline dynamically discovers CDK stacks and generates
# deployment jobs per tenant and environment.
#
# Structure:
#   - ci/gitlab/stages/     : Stage definitions
#   - ci/scripts/           : Helper scripts
#   - ci/discover_stages.py : Stack discovery logic
#   - ci/deploy_stages.py   : Deployment orchestration
#

# Global variables
variables:
  CDK_DISABLE_TYPEGUARD: "1"
  AWS_DEFAULT_REGION: "eu-west-1"
  AWS_PRINCIPAL_ACCOUNT_ID: "111111111111"
  # NOTE: probably useless cause image is already defined in the default section
  # CI_BASE_IMAGE: "111111111111.dkr.ecr.eu-west-1.amazonaws.com/infra/osd-cdk-ci-runner@sha256:REDACTED_IMAGE_HASH"
  # ECR_IMAGE: "$CI_BASE_IMAGE"
  # ðŸ”¥ OBLIGATOIRE pour eu-central-2 (rÃ©gions rÃ©centes)
  AWS_STS_REGIONAL_ENDPOINTS: "regional"

# Default Docker image for all jobs
default:
  image: $LATEST_CDK_DEPLOY_ECR_IMAGE

# Pipeline stages
stages:
  - validate      # Code quality checks
  - discover      # Discover CDK stacks
  - bootstrap     # One-time account setup (manual)
  - deploy-shared # Deploy shared infrastructure (S3 buckets, ECR repos) (manual)
  - trigger       # Launch child pipelines per environment
  - deploy        # Child pipeline jobs (diff + deploy per tenant)

# Include stage definitions
include:
  - local: ci/gitlab/stages/01-validate.yml
  - local: ci/gitlab/stages/02-discover.yml
  - local: ci/gitlab/stages/03-bootstrap.yml
  - local: ci/gitlab/stages/04-deploy-shared.yml
  - local: ci/gitlab/stages/05-triggers.yml
