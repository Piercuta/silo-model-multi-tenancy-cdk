# =======================================
# GitLab CI/CD - Tenant-Specific Stack Deployment Pipeline
# =======================================
#
# This pipeline is designed to be triggered from an external GitLab project
# to deploy a specific stack (default: ApplicationStack) for a given tenant and environment.
#
# Required variables (passed from external project):
#   - TENANT: Tenant name (e.g., "Pco", "Fr", "Che")
#   - ENV: Environment name (e.g., "Dev", "Stg", "Prd")
#
# Optional variables:
#   - STACK_NAME: Stack name to deploy (default: "ApplicationStack")
#   - ECR_IMAGE_URI: ECR image URI for ECS services (required)
#
# Deployment behavior:
#   - Dev environment: Automatic deployment after successful diff
#   - Other environments (Stg, Prd, etc.): Manual deployment (requires approval)
#
# Usage from external GitLab project:
#   trigger:
#     include:
#       - project: 'path/to/this-project'
#         file: '.gitlab-ci-deploy-tenant.yml'
#     variables:
#       TENANT: "Pco"
#       ENV: "Dev"
#       STACK_NAME: "ApplicationStack"  # optional
#       ECR_IMAGE_URI: "111111111111.dkr.ecr.eu-west-1.amazonaws.com/my-app:tag"  # optional
#

# Global variables
variables:
  CDK_DISABLE_TYPEGUARD: "1"
  AWS_DEFAULT_REGION: "eu-west-1"
  AWS_PRINCIPAL_ACCOUNT_ID: "111111111111"
  # CI_BASE_IMAGE: "111111111111.dkr.ecr.eu-west-1.amazonaws.com/infra/osd-cdk-ci-runner@sha256:REDACTED_IMAGE_HASH"
  # ECR_IMAGE: "$CI_BASE_IMAGE"
  # üî• OBLIGATOIRE pour eu-central-2 (r√©gions r√©centes)
  AWS_STS_REGIONAL_ENDPOINTS: "regional"
  # Default stack name if not provided
  STACK_NAME: "${STACK_NAME:-ApplicationStack}"

# Default Docker image for all jobs
default:
  image: $LATEST_CDK_DEPLOY_ECR_IMAGE

# Pipeline stages
stages:
  - diff
  - deploy

# Common template for setup
.setup_template:
  variables:
    CDK_DISABLE_TYPEGUARD: "1"
  before_script:
    - |
      # Validate required variables
      if [ -z "$TENANT" ] || [ -z "$ENV" ]; then
        echo "‚ùå ERROR: TENANT and ENV variables are required"
        exit 1
      fi

      # Convert to lowercase for CDK context
      TENANT_LOWER=$(echo "$TENANT" | tr '[:upper:]' '[:lower:]')
      ENV_LOWER=$(echo "$ENV" | tr '[:upper:]' '[:lower:]')

      # Build stage name: TenantEnvStage (e.g., PcoDevStage)
      TENANT_PASCAL=$(echo "$TENANT" | sed 's/^./\U&/')
      ENV_PASCAL=$(echo "$ENV" | sed 's/^./\U&/')
      STAGE_NAME="${TENANT_PASCAL}-${ENV_PASCAL}"

      # Build stack pattern and CDK context
      STACK_PATTERN="${STAGE_NAME}/${STACK_NAME}"
      CDK_CONTEXT="-c tenant=${TENANT_LOWER} -c env=${ENV_LOWER}"

      # Add ECR image URI to context if provided
      if [ -n "$ECR_IMAGE_URI" ]; then
        CDK_CONTEXT="${CDK_CONTEXT} -c ecr_image_osd_api_uri=${ECR_IMAGE_URI}"
      fi

      # Export for script section
      export STACK_NAME STAGE_NAME STACK_PATTERN CDK_CONTEXT

      echo "üìã Tenant: $TENANT | Env: $ENV | Stage: $STAGE_NAME | Stack: $STACK_NAME"
      if [ -n "$ECR_IMAGE_URI" ]; then
        echo "   ECR Image URI: $ECR_IMAGE_URI"
      fi
  rules:
    - if: '$TENANT && $ENV'

# Diff job
diff:
  extends: .setup_template
  stage: diff
  allow_failure: true
  script:
    - |
      echo "üìä Running diff for stack: $STACK_PATTERN"
      cdk diff "$STACK_PATTERN" $CDK_CONTEXT | tee diff_output.txt
      DIFF_EXIT_CODE=${PIPESTATUS[0]}

      # Check for dangerous operations
      if grep -iE "requires replacement|dangerous word" diff_output.txt > /dev/null; then
        echo ""
        echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è"
        echo "‚ö†Ô∏è  WARNING: DESTRUCTIVE CHANGES DETECTED!"
        echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è"
        grep -iE "requires replacement|dangerous word" diff_output.txt | head -20
        echo ""
        echo "‚ö†Ô∏è  Please review carefully before deploying!"
        rm -f diff_output.txt
        exit 1
      else
        echo "‚úÖ No destructive changes detected"
        rm -f diff_output.txt
        exit $DIFF_EXIT_CODE
      fi
  when: on_success

# Deploy job
deploy:
  extends: .setup_template
  stage: deploy
  needs:
    - job: diff
      artifacts: false
  script:
    - |
      echo "üöÄ Deploying stack: $STACK_PATTERN"
      cdk deploy "$STACK_PATTERN" $CDK_CONTEXT --exclusively --require-approval never --concurrency 4 --progress events
  environment:
    name: "${TENANT}-${ENV}-${STACK_NAME}"
  rules:
    # Automatic deployment for dev environment
    - if: '$TENANT && $ENV == "Dev"'
      when: on_success
    # Manual deployment for other environments
    - if: '$TENANT && $ENV'
      when: manual
