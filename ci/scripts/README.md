# CI Scripts

Helper scripts for GitLab CI pipeline automation.

## Scripts

### discover_stages.py

**Purpose**: Discover CDK stacks and generate dynamic GitLab CI job files.

**Inputs**:
- `cdk_stacks_long.yml` - Output from `cdk list --long`
- Environment variables:
  - `AWS_PRINCIPAL_ACCOUNT_ID` - Principal AWS account (defaults to `AWS_ACCOUNT_ID` or `111111111111`)
  - `AWS_DEFAULT_REGION` - AWS region
  - `ECR_IMAGE` - ECR image URI for GitLab CI jobs (optional, has default)

**Outputs**:
- `stages_config.json` - Stage configuration
- `gitlab-ci-dynamic-jobs-dev.yml` - Dev environment jobs
- `gitlab-ci-dynamic-jobs-stg.yml` - Staging environment jobs
- `gitlab-ci-dynamic-jobs-prd.yml` - Production environment jobs
- `bootstrap_config.json` - Bootstrap configuration for discovered accounts

**Usage**:
```bash
cdk list --long | grep -v '^`' | grep -v '^current credentials' | grep -v '^$' > cdk_stacks_long.yml
python3 ci/scripts/discover_stages.py
```

---

### bootstrap_accounts.py

**Purpose**: Bootstrap AWS accounts for CDK deployments with cross-account support.

**Inputs**:
- `bootstrap_config.json` - Generated by `discover_stages.py`
- AWS credentials (for AssumeRole)

**Features**:
- ✅ Bootstrap principal account directly
- ✅ AssumeRole into target accounts via `GitLabCrossAccount`
- ✅ Set up trust relationships automatically
- ✅ Create required service-linked roles (e.g., `ecs.amazonaws.com`)
- ✅ Handle bootstrap failures gracefully

**Requirements**:
- `boto3` Python package
- `GitLabCrossAccount` must exist in target accounts with trust policy allowing principal account's `ops-cicd` user
- `AWS_STS_REGIONAL_ENDPOINTS` environment variable set to `"regional"` (required for newer regions like eu-central-2)

**Usage**:
```bash
python3 ci/scripts/bootstrap_accounts.py
```

**Exit codes**:
- `0` - Success or no bootstrap needed
- Non-zero - Critical error

---

## Testing Locally

### Test discover_stages.py
```bash
# Activate virtual environment
source .venv/bin/activate

# Generate stack list (matching CI pipeline command)
cdk list --long | grep -v '^`' | grep -v '^current credentials' | grep -v '^$' > cdk_stacks_long.yml

# Run discovery
python3 ci/scripts/discover_stages.py

# Check outputs
ls -la gitlab-ci-dynamic-jobs-*.yml bootstrap_config.json stages_config.json
```

### Test bootstrap_accounts.py
```bash
# Requires valid AWS credentials and bootstrap_config.json
export AWS_PRINCIPAL_ACCOUNT_ID="111111111111"
export AWS_DEFAULT_REGION="eu-west-1"
export AWS_STS_REGIONAL_ENDPOINTS="regional"  # Required for newer regions

python3 ci/scripts/bootstrap_accounts.py
```

**Note**: Bootstrap is typically run in CI/CD, not locally, unless testing.
